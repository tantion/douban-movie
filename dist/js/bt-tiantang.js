define(function(require,a,b){"use strict";function c(){var a=this.href,b=null,c=i(a).param(),d=new h.Deferred;return a?(b=h('<form method="POST" action="http://www.bttiantang.com/download.php"><input type="hidden" name="action" value="download"/><input type="hidden" name="id" value="'+c.id+'"/> <input type="hidden" name="uhash" value="'+c.uhash+'"/></form>'),j||(j=h("<iframe />").appendTo("body")),j.html(b),b.submit()):d.reject(),d.promise()}function d(a){var b=h(a),c=b.find("small"),d="",e="";return c.remove(),d=h.trim(b.text()),d=d.replace(/\.(\w+)$/i,".<strong>$1</strong>"),e=h.trim(c.text()),e=e?"<strong>"+e+"</strong>":"",d=e?d+" "+e:d,{title:d}}function e(a){var b=new h.Deferred,c="";return l.hasOwnProperty(a)?(c=l[a],c?b.resolve(c):b.reject()):h.ajax({url:"http://www.bttiantang.com/s.php?q=#imdb#".replace("#imdb#",a),type:"GET",timeout:k,xhrFields:{withCredentials:!0}}).done(function(d){var e=d.match(/<div class="litpic"><a href="(\/subject\/\d+\.html)"/i);e&&e.length>1&&(c=e[1]),c?(c="http://www.bttiantang.com"+c,l[a]=c,b.resolve(c)):(l[a]=c,b.reject())}).fail(function(){b.reject()}),b.promise()}function f(a){var b=new h.Deferred,e=null;return m.hasOwnProperty(a)?(e=m[a],e?b.resolve(e):b.reject()):h.ajax({url:a,type:"GET",timeout:k,xhrFields:{withCredentials:!0}}).done(function(f){f=f.replace(/src=/gi,"data-src=");var g=h(h.parseHTML(f)),i=g.find(".tinfo"),j=[];i.each(function(){var a=h(this),b=a.children("a"),e=a.find(".video");j.push({href:"http://www.bttiantang.com"+b.attr("href"),download:c,title:h.trim(b.text()),files:h.map(e,d)})}),j.length?(e={items:j},m[a]=e,b.resolve(e)):(m[a]=e,b.reject())}).fail(function(){b.reject()}),b.promise()}function g(a){var b=new h.Deferred,c=""+a.imdb;return c?(b.notify("正在加载搜索结果，服务器网络慢的话需要等待几秒..."),e(c).done(function(a){b.notify("马上就好，正在加载BT地址..."),f(a).done(function(a){b.resolve(a)}).fail(function(){b.reject()})}).fail(function(){b.reject()})):b.reject(),b.promise()}var h=require("jquery"),i=require("purl"),j=null,k=2e4,l={},m={};b.exports={search:g}});