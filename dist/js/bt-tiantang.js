define(function(require,a,b){"use strict";function c(a){var b=null,c=k(a).param(),d=new i.Deferred;return c&&c.id&&c.uhash?(b=i('<form method="POST" action="http://www.bttiantang.com/download.php"><input type="hidden" name="action" value="download"/><input type="hidden" name="id" value="'+c.id+'"/> <input type="hidden" name="uhash" value="'+c.uhash+'"/></form>'),l||(l=i("<iframe />").appendTo("body")),l.html(b),b.submit()):d.reject(),d.promise()}function d(a){var b=i(a),c=b.find("small"),d="",e="";return c.remove(),d=i.trim(b.text()),d=d.replace(/\.(\w+)$/i,".<strong>$1</strong>"),e=i.trim(c.text()),e=e?"<strong>"+e+"</strong>":"",d=e?d+" "+e:d,{title:d}}function e(a){var b=j.render(p,{items:a}),d=i(b);return d.on("mouseenter",".movie-improve-bt-download",function(){i(this).tipsy({gravity:"w",offset:3}).tipsy("show")}).on("click",".movie-improve-bt-download",function(a){a.preventDefault();var b=i(this);c(b.attr("href")).fail(function(){b.attr("title","没有找到下载地址。")})}),d}function f(a){var b=new i.Deferred,c="";return n.hasOwnProperty(a)?(c=n[a],c?b.resolve(c):b.reject()):i.ajax({url:"http://www.bttiantang.com/s.php?q=#imdb#".replace("#imdb#",a),type:"GET",timeout:m,xhrFields:{withCredentials:!0}}).done(function(c){var d=c.match(/<div class="litpic"><a href="(\/subject\/\d+\.html)"/i),e="";d&&d.length>1&&(e=d[1]),e?(e="http://www.bttiantang.com"+e,n[a]=e,b.resolve(e)):(n[a]=e,b.reject())}).fail(function(){b.reject()}),b.promise()}function g(a){var b=new i.Deferred,c=null;return o.hasOwnProperty(a)?(c=o[a],c&&c.length?b.resolve(c):b.reject()):i.ajax({url:a,type:"GET",timeout:m,xhrFields:{withCredentials:!0}}).done(function(c){c=c.replace(/src=/gi,"data-src=");var e=i(i.parseHTML(c)),f=e.find(".tinfo"),g=[];g=i.map(f,function(a){var b=i(a),c=b.children("a"),e=b.find(".video");return{href:"http://www.bttiantang.com"+c.attr("href"),title:i.trim(c.text()),files:i.map(e,d)}}),o[a]=g,g.length?b.resolve(g):b.reject()}).fail(function(){b.reject()}),b.promise()}function h(a){var b=new i.Deferred,c="";return c=a.imdb?""+a.imdb:encodeURI(a.title2),c?(b.notify("正在加载搜索结果，服务器网络慢的话需要等待几秒..."),f(c).done(function(a){b.notify("马上就好，正在加载BT地址..."),g(a).done(function(a){b.resolve(e(a))}).fail(function(){b.reject()})}).fail(function(){b.reject()})):b.reject(),b.promise()}var i=require("jquery"),j=require("mustache"),k=require("purl"),l=null,m=3e4,n={},o={},p='{{#items}}<dl class="movie-improve-bt-dl"><dt class="movie-improve-bt-title"><a title="点击下载种子" class="movie-improve-bt-download" href="{{href}}">{{title}}</a></dt>{{#files}}<dd class="movie-improve-bt-desc">{{&title}}</dd>{{/files}}</dl>{{/items}}';b.exports={name:"BT天堂",search:h}});