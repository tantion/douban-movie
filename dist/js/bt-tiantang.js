define("js/bt-tiantang",function(require,a,b){"use strict";function c(a){return/^http:\/\/www\.bttiantang\.com\/download\.php/i.test(a)?!0:!1}function d(a){var b=null,c=m(a).param(),d=new k.Deferred;return c&&c.id&&c.uhash?(b=k('<form method="POST" action="http://www.bttiantang.com/download.php"><input type="hidden" name="action" value="download"/><input type="hidden" name="down" value="d1"/><input type="hidden" name="id" value="'+c.id+'"/> <input type="hidden" name="uhash" value="'+c.uhash+'"/></form>'),p||(p=k("<iframe />").appendTo("body")),p.html(b),b.submit()):d.reject(),d.promise()}function e(a){var b=k.Deferred(),c=m(a).param(),d=null,e=null;return c&&c.id&&c.uhash?(e=new XMLHttpRequest,e.open("POST","http://www.bttiantang.com/download.php",!0),e.responseType="arraybuffer",e.onload=function(){var a=new Blob([e.response],{type:"application/octet-stream"});b.resolve(a)},e.timeout=6e4,e.onerror=function(){b.reject("网络错误")},e.ontimeout=function(){b.reject("下载bt超时")},d=new FormData,d.append("action","download"),d.append("down","d1"),d.append("id",c.id),d.append("uhash",c.uhash),e.send(d)):b.reject("地址错误"),b.promise()}function f(a){var b=k(a),c=b.find("small"),d="",e="";return c.remove(),d=k.trim(b.text()),d=d.replace(/\.(\w+)$/i,".<strong>$1</strong>"),e=k.trim(c.text()),e=e?"<strong>"+e+"</strong>":"",d=e?d+" "+e:d,{title:d}}function g(a){var b=l.render(t,{items:a}),c=k(b);return c.on("mouseenter",".movie-improve-bt-download",function(){k(this).tipsy({gravity:"w",offset:3}).tipsy("show")}).on("click",".movie-improve-bt-download",function(a){if(!n.isDefaultPrevented(a)){a.preventDefault();var b=k(this);o.log("正在下载中... 同时 `Shift+单击` 可云播"),d(b.attr("href")).fail(function(){o.error("网络错误，下载失败")})}}),c}function h(a,b){var c=new k.Deferred,d="";return r.hasOwnProperty(a)?(d=r[a],d?c.resolve(d):c.reject()):k.ajax({url:"http://www.bttiantang.com/s.php?q=#imdb#".replace("#imdb#",a),type:"GET",timeout:q,xhrFields:{withCredentials:!0}}).done(function(d){d=d.replace(/src=/gi,"data-src=");var e="",f=k(k.parseHTML(d)),g=f.find(".ml .item"),h=[];h=k.map(g,function(a){var b=k(a),c=b.find(".title"),d=c.find(".tt a"),e=parseInt(k.trim(d.text()).replace(/.*\.(\d+)$/,"$1"),10);return{href:d.attr("href"),year:e}}),h.length>0&&(e=h[0].href,h.length>1&&k.each(h,function(a,c){c.year===b&&(e=c.href)})),e?(e="http://www.bttiantang.com"+e,r[a]=e,c.resolve(e)):(r[a]=e,c.reject())}).fail(function(){c.reject()}),c.promise()}function i(a){var b=new k.Deferred,c=null;return s.hasOwnProperty(a)?(c=s[a],c&&c.length?b.resolve(c):b.reject()):k.ajax({url:a,type:"GET",timeout:q,xhrFields:{withCredentials:!0}}).done(function(c){c=c.replace(/src=/gi,"data-src=");var d=k(k.parseHTML(c)),e=d.find(".tinfo"),g=[];g=k.map(e,function(a){var b=k(a),c=b.children("a"),d=b.find(".video");return{href:"http://www.bttiantang.com"+c.attr("href"),title:k.trim(c.text()),files:k.map(d,f)}}),s[a]=g,g.length?b.resolve(g):b.reject()}).fail(function(){b.reject()}),b.promise()}function j(a){var b=new k.Deferred,c="";return c=a.imdb?""+a.imdb:encodeURI(a.title2),c?(b.notify("正在加载搜索结果，服务器网络慢的话需要等待几秒..."),h(c,a.year).done(function(a){b.notify("马上就好，正在加载BT地址..."),i(a).done(function(a){b.resolve(g(a),a.length)}).fail(function(){b.reject()})}).fail(function(){b.reject()})):b.reject(),b.promise()}var k=require("jquery"),l=require("mustache"),m=require("purl"),n=require("private/adapter"),o=require("alertify"),p=null,q=3e4,r={},s={},t='{{#items}}<dl class="movie-improve-bt-dl"><dt class="movie-improve-bt-title"><a title="点击下载种子" class="movie-improve-bt-download private-play-download-link" href="{{href}}">{{title}}</a></dt>{{#files}}<dd class="movie-improve-bt-desc">{{&title}}</dd>{{/files}}</dl>{{/items}}';b.exports={name:"BT天堂",load:e,isTiangtangUrl:c,search:j}});