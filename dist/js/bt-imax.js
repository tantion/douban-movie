define(function(require,a,b){"use strict";function c(a){var b=h.render(l,{items:a}),c=g(b);return c.on("mouseenter","a",function(){g(this).tipsy({gravity:"w",offset:3}).tipsy("show")}),c}function d(a){var b=new g.Deferred,c="";return j.hasOwnProperty(a)?(c=j[a],c?b.resolve(c):b.reject()):g.ajax({url:"http://imax.im/api/movies/show.json?douban_url=#url#".replace("#url#",a),type:"GET",timeout:i,dataType:"json"}).done(function(c){var d="";c&&c.has_attach&&c.id?(d="http://imax.im/movies/"+c.id,j[a]=d,b.resolve(d)):(j[a]=d,b.reject())}).fail(function(){b.reject()}),b.promise()}function e(a){var b=new g.Deferred,c=null;return k.hasOwnProperty(a)?(c=k[a],c?b.resolve(c):b.reject()):g.ajax({url:a,type:"GET",timeout:i,xhrFields:{withCredentials:!0}}).done(function(c){c=c.replace(/src=/gi,"data-src=");var d=g(g.parseHTML(c)),e=d.find("tr .attach"),f=[];f=g.map(e,function(a){var b=g(a),c=b.closest("tr"),d=g.trim(c.find(".qu").text()),e=g.trim(c.find(".size").text()),f=g.trim(b.text()),h=b.attr("href"),i="";return d&&(i="["+d+"]"),e&&(i+="[<strong>"+e+"</strong>]"),i+=f,{href:h,title:i}}),k[a]=f,f.length?b.resolve(f):b.reject()}).fail(function(){b.reject()}),b.promise()}function f(){var a=new g.Deferred;return a.notify("正在加载搜索结果，请稍候..."),d(location.href).done(function(b){a.notify("马上就好，正在加载下载地址..."),e(b).done(function(b){a.resolve(c(b),b.length)}).fail(function(){a.reject()})}).fail(function(){a.reject()}),a.promise()}var g=require("jquery"),h=require("mustache"),i=3e4,j={},k={},l='{{#items}}<dl class="movie-improve-bt-dl"><dt class="movie-improve-bt-title"><a title="请右键复制下载地址或者点击下载。" href="{{href}}">{{&title}}</a></dt>{{#files}}<dd class="movie-improve-bt-desc">{{&title}}</dd>{{/files}}</dl>{{/items}}';b.exports={name:"IMAX.im",search:f}});