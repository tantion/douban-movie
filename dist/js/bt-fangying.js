define(function(require,a,b){"use strict";function c(a){var b=h.render(l,{items:a}),c=g(b);return c.on("mouseenter","a",function(){g(this).tipsy({gravity:"w",offset:3}).tipsy("show")}),c}function d(a){var b=new g.Deferred,c=null;return i.hasOwnProperty(a)?(c=i[a],c&&c.length?b.resolve(c):b.reject()):g.ajax({url:a,type:"GET",timeout:k,xhrFields:{withCredentials:!0}}).done(function(c){c=c.replace(/src=/gi,"data-src=");var d=g(g.parseHTML(c)),e=d.find("#tab-magnet").find(".row"),f=[];f=g.map(e,function(a){var b=g(a),c=b.children(".span7"),d=c.find("a"),e=g.trim(d.text()),f=c.find('span[class!="play-count"]').text(),h=c.find(".play-count").text();return f&&(e="[<strong>"+f+"</strong>]"+e),h&&(e="[<strong>"+h+"</strong>]"+e),{href:d.attr("href"),title:e,files:null}}),i[a]=f,f.length?b.resolve(f):b.reject()}).fail(function(){b.reject()}),b.promise()}function e(a,b,c){var d=new g.Deferred,e="";return a=encodeURI(a),j.hasOwnProperty(a)?(e=j[a],e?d.resolve(e):d.reject()):g.ajax({url:"http://www.fangying.tv/category/key_#title#".replace("#title#",a),type:"GET",timeout:k,xhrFields:{withCredentials:!0}}).done(function(e){e=e.replace(/src=/gi,"data-src=");var f="",h=g(g.parseHTML(e)),i=h.find(".movie-list .film"),k=!1,l=[];l=g.map(i,function(a){var b=g(a),c=b.find(".movie-title"),d=c.find("a"),e=c.find("small"),f=b.find(".performer"),h=parseInt(g.trim(e.text()).replace(/\((\d+)\)$/,"$1"),10);return{href:d.attr("href"),year:h,actor:g.trim(f.text()).replace(/([^\/ ]+).*/,"$1")}}),l.length>0&&(f=l[0].href,l.length>1&&(g.each(l,function(a,c){k||c.year!==b||(f=c.href,k=!0)}),k||g.each(l,function(a,b){!k&&c.indexOf(b.actor)>-1&&(f=b.href,k=!0)}))),j[a]=f,f?d.resolve(f):d.reject()}).fail(function(){d.reject()}),d.promise()}function f(a){var b=a.title2||a.title,f=new g.Deferred;return b?(f.notify("正在加载搜索结果，请耐心等待..."),e(b,a.year,a.actors).done(function(a){f.notify("马上就好，正在加载BT地址..."),d(a).done(function(a){f.resolve(c(a),a.length)}).fail(function(){f.reject()})}).fail(function(){f.reject()})):f.reject(),f.promise()}var g=require("jquery"),h=require("mustache"),i={},j={},k=3e4,l='{{#items}}<dl class="movie-improve-bt-dl"><dt class="movie-improve-bt-title"><a title="请右键复制下载地址或者点击下载。" href="{{href}}">{{&title}}</a></dt>{{#files}}<dd class="movie-improve-bt-desc">{{&title}}</dd>{{/files}}</dl>{{/items}}';b.exports={name:"放映TV",search:f}});