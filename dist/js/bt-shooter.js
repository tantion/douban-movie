define(function(require,a,b){"use strict";function c(){var a=new j.Deferred;return n?a.resolve(n):j.ajax({type:"GET",url:"http://www.shooter.cn/a/loadmain.js",timeout:m,dataType:"html"}).done(function(b){var c=b.match(/shtg_filehash ?\+?= ?"\w+";/gi);c&&(n=j.map(c,function(a){return a.replace(/^.+"(\w+)";$/,"$1")}).join(""),n?a.resolve(n):a.reject())}).fail(function(){a.reject()}),a.promise()}function d(a){var b=new j.Deferred;return a?o.hasOwnProperty(a)?o[a]?b.resolve(o[a]):b.reject():j.ajax({url:a,type:"GET",timeout:m,dataType:"html"}).done(function(c){var d=c.match(/gFileidToBeDownlaod = (\d+);/i),e=0;d&&d[1]?(e=d[1],o[a]=e,b.resolve(e)):(o[a]=e,b.reject())}).fail(function(){b.reject()}):b.reject(),b.promise()}function e(a){var b=new j.Deferred;return j.when(d(a),c()).done(function(a,c){var d="http://www.shooter.cn/files/file3.php?hash="+c+"&fileid="+a;j.ajax({url:d,type:"GET",dataType:"html"}).done(function(a){if(a&&a.indexOf("ERR:")<0){var c=l.decode(a);c?(c="http://file1.shooter.cn"+c,b.resolve(c)):b.reject()}else b.reject()}).fail(function(){b.reject()})}).fail(function(){b.reject()}),b.promise()}function f(a){var b=new j.Deferred;return e(a).done(function(a){a?location.href=a:b.reject()}).fail(function(){b.reject()}),b.promise()}function g(a){var b=k.render(q,{items:a}),c=j(b);return c.on("mouseenter",".movie-improve-bt-download",function(){j(this).tipsy({gravity:"w",offset:3}).tipsy("show")}).on("click",".movie-improve-bt-download",function(a){a.preventDefault();var b=j(this);f(b.attr("href")).fail(function(){b.attr("title","没有找到下载地址。")})}),c}function h(a){var b=new j.Deferred,c="http://www.shooter.cn/search2/"+encodeURI(a),d=null;return p.hasOwnProperty(a)?(d=p[a],d&&d.length?b.resolve(d):b.reject()):j.ajax({url:c,type:"GET",timeout:m,xhrFields:{withCredentials:!0}}).done(function(c){c=c.replace(/src=/gi,"data-src=");var d=j(j.parseHTML(c)),e=d.find("#resultsdiv").eq(0).find(".introtitle"),f=[];f=j.map(e,function(b){var c=j(b),d=c.closest(".sublist_box_title").next().html()||"",e=c.parent().next().attr("title"),f=d.search("VobSub")?"srt":"",g=d.match(/语言： ([^<]+)<\//),h=d.match(/调校：([^<]+)<\//),i=j.trim(c.text());return f&&(d="["+f+"]"),g&&g[1]&&(d+="["+g[1]+"]"),e&&(d+="["+e+"]"),i=d+" "+i,h&&h[1]&&(d=j.trim(h[1]),d.match(/^[\w和]+$/)&&(d="")),i.search(a)>-1?{href:"http://www.shooter.cn"+c.attr("href"),title:i,desc:d}:null}),p[a]=f,f.length?b.resolve(f):b.reject()}).fail(function(){b.reject()}),b.promise()}function i(a){var b=new j.Deferred,c=""+a.title2;return c?(b.notify("正在加载字幕..."),h(c).done(function(a){b.resolve(g(a),a.length)}).fail(function(){b.reject()})):b.reject(),b.promise()}var j=require("jquery"),k=require("mustache"),l=require("js/util-decodefile.js"),m=3e4,n="",o={},p={},q='{{#items}}<dl class="movie-improve-bt-dl"><dt class="movie-improve-bt-title"><a title="点击下载字幕文件" class="movie-improve-bt-download" href="{{href}}">{{title}}</a></dt>{{#desc}}<dd class="movie-improve-bt-desc">{{&desc}}</dd>{{/desc}}</dl>{{/items}}';b.exports={name:"射手字幕",search:i}});